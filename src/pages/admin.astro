---
import Layout from '../layouts/Layout.astro';
import { getAllSubmissions } from '../lib/submissions';
import { requireAuth } from '../lib/session';

// Check authentication
try {
  requireAuth(Astro.cookies);
} catch {
  return Astro.redirect('/login', 302);
}

// Fetch submissions from database
let entries: Array<{
  id: number;
  firstName: string | null;
  lastName: string | null;
  email: string | null;
  phone: string | null;
  shirtSize: string | null;
  sneakerSize: string | null;
  createdAt: Date;
}> = [];

try {
  entries = await getAllSubmissions();
  // Sort entries alphabetically by name (case-insensitive)
  entries.sort((a, b) => {
    const nameA = `${a.firstName || ''} ${a.lastName || ''}`.trim().toLowerCase();
    const nameB = `${b.firstName || ''} ${b.lastName || ''}`.trim().toLowerCase();
    return nameA.localeCompare(nameB);
  });
} catch (error) {
  console.error('Error loading entries:', error);
}

// Helper function to split name into first and last
function splitName(name: string): { firstName: string; lastName: string } {
  const parts = name.trim().split(/\s+/);
  if (parts.length === 1) {
    return { firstName: parts[0], lastName: '' };
  }
  const lastName = parts.pop() || '';
  const firstName = parts.join(' ');
  return { firstName, lastName };
}
const imgBackground = "/assets/images/bg-2.png";
---

<Layout title="Admin Dashboard">
  <div class="relative min-h-screen md:py-12 py-4 md:px-6 px-2 bg-black" style="font-family: Helvetica, Arial, sans-serif;">
    <div 
      aria-hidden="true" 
      class="fixed-bg-mobile inset-0 pointer-events-none bg-no-repeat bg-center bg-cover"
      style={`background-image: url('${imgBackground}');`}
    ></div>
    <div 
      aria-hidden="true" 
      class="fixed inset-0 pointer-events-none bg-gradient-to-b from-transparent to-black/60 z-0"
    ></div>

    <!-- Header -->
    <div class="relative z-10 flex justify-between items-center md:mb-4 mb-4 md:pb-6 pb-4 border-b border-gray-200 max-w-7xl mx-auto">
        <div class="flex flex-row gap-4">
            <a href="/" class="h-[60px] overflow-clip relative shrink-0 w-[95px] md:w-[127px] md:h-[80px] md:ml-0 ml-3">
              <svg id="Layer_2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 375.06 152.68" class="block max-w-none size-full">
                <defs>
                  <style>.cls-1{fill-rule:evenodd;}.cls-1,.cls-2{fill:#fff;}</style>
                </defs>
                <g id="Layer_2-2">
                  <g id="Artwork_201">
                    <path class="cls-2" d="M49.2,47.9c-5.1-3.6-11.3-5.7-18-5.7C13.9,42.2,0,56.2,0,73.5s14,31.2,31.2,31.2,12.9-2.1,17.9-5.7v.2l14.6,4.2v-59.8l-14.6,4.2.1.1ZM31.7,90.8c-9.6,0-17.3-7.8-17.3-17.3s7.8-17.3,17.3-17.3,17.3,7.8,17.3,17.3-7.8,17.3-17.3,17.3M306.4,47.9c-5.1-3.6-11.3-5.7-18-5.7-17.3,0-31.3,14-31.3,31.3s14,31.2,31.3,31.2,12.9-2.1,17.9-5.7v.2l14.6,4.2v-59.8l-14.6,4.2.1.1ZM288.9,90.8c-9.6,0-17.3-7.8-17.3-17.3s7.8-17.3,17.3-17.3,17.3,7.8,17.3,17.3-7.8,17.3-17.3,17.3M125.7,73.5v.6-1.2.6M125.7,73.5v.6-1.2.6M125.7,73.5v.6-1.2.6M125.7,0v47.8c-5-3.5-11.2-5.5-17.8-5.5-17.3,0-31.3,14-31.3,31.3s14,31.2,31.3,31.2,12.7-2,17.8-5.5h0l14.8,4.3V.1h-14.8v-.1ZM125.7,74.1c-.3,9.3-7.9,16.7-17.3,16.7s-17.3-7.8-17.3-17.3,7.8-17.3,17.3-17.3,17,7.4,17.3,16.7v1.2M229.9,73.5v.9-1.8.9M229.9,73.5v.9-1.8.9M229.8,0v47.8c-5-3.5-11.2-5.5-17.8-5.5-17.3,0-31.3,14-31.3,31.3s14,31.2,31.3,31.2,12.7-2,17.8-5.5h0l14.8,4.3V.1h-14.8v-.1ZM229.8,74.4c-.5,9.1-8,16.4-17.3,16.4s-17.3-7.8-17.3-17.3,7.8-17.3,17.3-17.3,16.8,7.3,17.3,16.4v1.8M229.9,73.5v.9-1.8.9M153.4,43.7h14.8v59.8h-14.8v-59.8h0ZM168.3,28.5c0,4.1-3.3,7.4-7.4,7.4s-7.4-3.3-7.4-7.4,3.3-7.4,7.4-7.4,7.4,3.3,7.4,7.4M369.5,58.8c-7.4-4.7-14.5-5.7-17.4-2.7-1.2,1.2-2.1,3.3-1.6,5.2.7,2.7,4,3.7,7.9,5.4,5.6,2.5,12,5.5,14.9,10.6,3.8,6.7.3,14.9,0,15.4-2.2,4.8-5.8,7.3-7,8.1-12.4,8.4-31.2-1.1-32.2-1.6l4.1-12c1,.6,12.2,7.3,18.6,4.9.9-.4,2.8-1.1,3.8-2.9,1.1-2.1.4-4.5.2-4.8-1.2-3.5-5-3.7-11.3-7-4.9-2.6-9.6-5.1-12-10-2-4.4-1.3-8.6-1-9.9,1.3-6.5,6-10.1,7.5-11.2,6.5-4.7,13.8-4,16.9-3.7,6,.6,10.4,2.9,12.8,4.4l-4.2,11.9v-.1Z"/>
                    <path class="cls-1" d="M287,140.8c0-2.5,0-5.1-.2-7.6-.1-3.2-2.8-5.8-6-5.7-2.3-.1-7.2,0-7.4,0v25c.2,0,5.1.1,7.4,0,3.2,0,5.9-2.5,6-5.7.2-2,.2-4,.2-6M282.9,145.4c0,1.9-1.5,3.5-3.4,3.6h-2.2v-18c1,0,2.1.1,3.1.3,1.5.3,2.5,1.7,2.4,3.2v10.9h.1Z"/>
                    <path class="cls-1" d="M266.2,131c-1.1-2.7-3.5-3.6-6.4-3.5-3.7,0-6.4,2.3-6.5,5.9-.2,4.4-.1,8.8,0,13.2.1,3.4,2.2,5.5,5.6,6,4.4.5,7.6-1.5,8-5.9.2-2.1.1-9.8,0-11.5,0-1.4-.2-2.8-.7-4.1M262.9,146.3c0,1.5-1.2,2.7-2.7,2.7h-.3c-1.5,0-2.8-1.1-2.8-2.6v-12.5c0-1.6,1.1-2.9,2.7-3h.9c1.3.2,2.3,1.3,2.2,2.6v12.7h0v.1Z"/>
                    <path class="cls-1" d="M192.3,129.5c-1.5-1.5-3.6-2.3-5.8-2-3.2,0-5.9,2.6-6,5.9-.1,4.4,0,8.9,0,13.3,0,1.6.7,3.2,1.9,4.3,1.4,1.2,3.2,1.8,5,1.6,3.3.2,6.2-2.3,6.4-5.6v-.2c.1-2.2.2-10.2.2-12,0-1.9-.5-3.8-1.7-5.3M190.1,146.2c0,1.5-1.1,2.8-2.6,2.9-.3,0-.6,0-.9-.1-1.3-.2-2.3-1.4-2.2-2.7v-12.5c0-1.5,1.1-2.7,2.6-2.8h.3c1.5,0,2.7,1.1,2.8,2.5v12.6h0v.1Z"/>
                    <path class="cls-1" d="M200.6,127.5v25c0,.2,0,0,0,0h3.9v-10.1h5.6v-3.9h-5.6v-7.7h7.6v-3.5h-11.6l.1.2Z"/>
                    <path class="cls-1" d="M246.6,138.9h-7v3.2h3.3c.1,1,0,5.7,0,6.7-1.2.8-2.7,1.1-4,.7-2-.6-2-2.4-2.1-4.5-.1-2.5-.2-3.9-.2-6.4v-4.6c0-1.3.9-2.5,2.3-2.7,1.5-.3,2.9.6,3.2,2.1v.3c.2.8.2,1.7.3,2.5h4.1c0-.9-.2-1.8-.4-2.6-.3-2.4-1.3-4.4-3.6-5.4-2.5-1.2-5.5-.8-7.7.9-.6.5-1,1-1.3,1.7-.5,1.3-.9,2.6-.9,4-.1,3-.1,6,0,9.1,0,1.4.2,2.8.5,4.1.5,2.5,2.7,4.4,5.3,4.5,6,.7,8.1-2.5,8.1-2.5v-11.1h.1Z"/>
                    <path class="cls-1" d="M129.1,127.5c-1.3,7.1-2.8,14.8-4.2,21.9-.2,1.1-.4,2.1-.6,3.2h3.8c.3-1.8.7-3.6,1-5.4h5.4c.4,1.8.7,3.6,1.1,5.4h4.1c-1.7-8.4-3.4-16.7-5.1-25.1h-5.5M129.8,143.5l2-10.8h.1l2,10.8h-4.1Z"/>
                    <path class="cls-1" d="M106.3,152.6h11.4v-3.6h-7.5v-6.5h5.5v-3.9h-5.6v-7.7h7.5v-3.5h-11.4v25.1l.1.1Z"/>
                    <polygon class="cls-1" points="88.2 152.6 92.1 152.6 92.1 142.5 97.8 142.5 97.7 138.7 92.2 138.7 92.2 131 99.8 131 99.8 127.5 88.2 127.5 88.2 152.6"/>
                    <path class="cls-1" d="M156.2,141.2c2-.8,3.3-2.7,3.4-4.8.2-1.2.2-2.5,0-3.7-.3-3.2-2.6-5.2-6-5.2h-7.4v25.1h3.9v-10.2h2.3c1,3,2.4,7.2,3.4,10.2h4.2c-1.2-3.6-2.7-8.1-3.8-11.4h0ZM155.8,135.7c0,1.8-1.5,2.6-3.4,2.7h-2.2v-7.8c1,0,2.1,0,3.1.1,1.5.3,2.4.8,2.4,2.5v2.4h0l.1.1Z"/>
                  </g>
                </g>
              </svg>
            </a>
        </div>
        <div class="flex gap-2">
          <!-- Export CSV Button -->
            <button
            id="export-csv-btn"
            class="md:px-6 px-3 md:py-3 py-2 border border-gray-200 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center gap-2.5 font-semibold uppercase text-sm shadow-sm"
            style="font-family: Helvetica, Arial, sans-serif;"
            >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            Export CSV
            </button>
            <button
            id="logout-btn"
            class="md:px-6 px-3 md:py-3 py-2 border border-gray-200 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center gap-2.5 font-semibold uppercase text-sm shadow-sm"
            style="font-family: Helvetica, Arial, sans-serif;"
            >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Logout
            </button>
        </div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto bg-white/90 rounded-xl shadow-md md:p-10 p-2">
      <!-- Search and Filter Section -->
      <div class="flex flex-col sm:flex-row gap-2 sm:gap-5 md:mb-8 mb-3 sm:items-center">
        <div class="flex-1 relative w-full">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
          </div>
          <input
            type="text"
            id="search-input"
            placeholder="SEARCH ENTRIES"
            class="w-full pl-12 pr-5 py-3.5 border border-gray-200 rounded-lg bg-gray-50/50 text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:border-transparent font-semibold uppercase text-sm"
            style="font-family: Helvetica, Arial, sans-serif;"
          />
        </div>
        <div class="relative w-full sm:w-auto">
          <button
            id="sort-btn"
            class="w-full sm:w-auto md:px-6 px-3 md:py-3.5 py-3.5 border border-gray-200 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center gap-2 font-semibold uppercase text-sm shadow-sm sm:min-w-[140px] justify-between"
            style="font-family: Helvetica, Arial, sans-serif;"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
              </svg>
              <span id="sort-label">Name (A-Z)</span>
            </span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            id="sort-dropdown"
            class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
            style="font-family: Helvetica, Arial, sans-serif;"
          >
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-semibold uppercase text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-between"
              data-sort="name-asc"
            >
              <span>Name (A-Z)</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-semibold uppercase text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-between border-t border-gray-100"
              data-sort="name-desc"
            >
              <span>Name (Z-A)</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
            <button
              class="sort-option w-full text-left px-4 py-3 text-sm font-semibold uppercase text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-between border-t border-gray-100"
              data-sort="date"
            >
              <span>Date</span>
              <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </button>
          </div>
        </div>
        <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide text-center sm:text-left md:pr-0 pr-3" style="font-family: Helvetica, Arial, sans-serif;">
            Showing <span id="entry-count" class="font-bold text-gray-700">{entries.length}</span> Entries
        </p>
      </div>

      <!-- Table Section -->
      <div class="md:mb-8 mb-2">
        <h2 class="text-2xl font-bold text-gray-800 uppercase tracking-tight md:mb-4 mb-2 md:pl-0 pl-3 text-center md:text-left" style="font-family: Helvetica, Arial, sans-serif;">Entries</h2>
      </div>

      <div class="overflow-x-auto rounded-xl shadow-md border bg-white border-gray-200">
        {entries.length === 0 ? (
          <div class="text-center py-16 text-gray-500" style="font-family: Helvetica, Arial, sans-serif;">
            <p class="text-lg font-semibold mb-2">No entries found.</p>
            <p class="text-sm">Entries will appear here once users submit the RSVP form.</p>
          </div>
        ) : (
          <table class="w-full border-collapse">
            <thead>
              <tr class="bg-[#F1F3F5]">
                <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300" style="font-family: Helvetica, Arial, sans-serif;">Name</th>
                <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200" style="font-family: Helvetica, Arial, sans-serif;">Email</th>
                <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200" style="font-family: Helvetica, Arial, sans-serif;">Phone</th>
                <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200" style="font-family: Helvetica, Arial, sans-serif;">Shirt Size</th>
                <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200" style="font-family: Helvetica, Arial, sans-serif;">Sneaker Size</th>
                <th class="px-2 py-2 md:px-6 md:py-4 text-center text-sm font-bold text-gray-600 uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-gray-300 border-l border-gray-200" style="font-family: Helvetica, Arial, sans-serif;">Actions</th>
              </tr>
            </thead>
            <tbody id="entries-tbody" class="divide-y divide-gray-200">
              {entries.map((entry) => {
              const fullName = `${entry.firstName || ''} ${entry.lastName || ''}`.trim() || '—';
              const firstName = (entry.firstName || '').toLowerCase();
              const dateValue = entry.createdAt instanceof Date 
                ? entry.createdAt.toISOString() 
                : new Date(entry.createdAt).toISOString();
              
              return (
                <tr 
                  class="hover:bg-gray-50/50 transition-colors" 
                  style="font-family: Helvetica, Arial, sans-serif;" 
                  data-entry-id={entry.id}
                  data-first-name={firstName.toLowerCase()}
                  data-created-at={dateValue}
                >
                  <td class="px-2 py-2 md:px-6 md:py-4 text-md font-semibold text-gray-800 capitalize border-l border-gray-100" style="font-family: Helvetica, Arial, sans-serif;">{fullName}</td>
                  <td class="px-2 py-2 md:px-6 md:py-4 text-md font-semibold text-gray-800 border-l border-gray-100" style="font-family: Helvetica, Arial, sans-serif;">{entry.email || '—'}</td>
                  <td class="px-2 py-2 md:px-6 md:py-4 text-md font-semibold text-gray-800 border-l border-gray-100" style="font-family: Helvetica, Arial, sans-serif;">{entry.phone || '—'}</td>
                  <td class="px-2 py-2 md:px-6 md:py-4 text-md font-semibold text-gray-800 border-l border-gray-100" style="font-family: Helvetica, Arial, sans-serif;">{entry.shirtSize || '—'}</td>
                  <td class="px-2 py-2 md:px-6 md:py-4 text-md font-semibold text-gray-800 border-l border-gray-100" style="font-family: Helvetica, Arial, sans-serif;">{entry.sneakerSize || '—'}</td>
                  <td class="px-2 py-2 md:px-6 md:py-4 text-center border-l border-gray-100" style="font-family: Helvetica, Arial, sans-serif;">
                    <button
                      class="delete-entry-btn px-3 py-1.5 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm font-semibold uppercase flex items-center gap-2 mx-auto"
                      data-entry-id={entry.id}
                      data-entry-name={fullName}
                      style="font-family: Helvetica, Arial, sans-serif;"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </td>
                </tr>
              );
              })}
            </tbody>
          </table>
        )}
      </div>
    </div>
  </div>

  <script>
    // Store original entries data
    const originalEntries = { entries: [...document.querySelectorAll('[data-entry-id]')] };

    // Search functionality
    const searchInput = document.getElementById('search-input');
    const entriesTbody = document.getElementById('entries-tbody');
    let currentSort = 'name-asc'; // Default sort
    
    searchInput?.addEventListener('input', (e) => {
      const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
      filterAndSortEntries();
    });

    // Sort dropdown functionality
    const sortBtn = document.getElementById('sort-btn');
    const sortDropdown = document.getElementById('sort-dropdown');
    const sortLabel = document.getElementById('sort-label');
    const sortOptions = document.querySelectorAll('.sort-option');

    // Toggle dropdown
    sortBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = sortDropdown?.classList.contains('hidden');
      if (isOpen) {
        sortDropdown?.classList.remove('hidden');
        sortBtn.setAttribute('aria-expanded', 'true');
      } else {
        sortDropdown?.classList.add('hidden');
        sortBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!sortBtn?.contains(e.target as Node) && !sortDropdown?.contains(e.target as Node)) {
        sortDropdown?.classList.add('hidden');
        sortBtn?.setAttribute('aria-expanded', 'false');
      }
    });

    // Handle sort option clicks
    sortOptions.forEach((option) => {
      option.addEventListener('click', () => {
        const sortValue = option.getAttribute('data-sort');
        if (sortValue) {
          currentSort = sortValue;
          
          // Update label
          const labels: Record<string, string> = {
            'name-asc': 'Name (A-Z)',
            'name-desc': 'Name (Z-A)',
            'date': 'Date'
          };
          if (sortLabel) {
            sortLabel.textContent = labels[sortValue] || 'Name (A-Z)';
          }
          
          // Update checkmarks
          sortOptions.forEach((opt) => {
            const icon = opt.querySelector('.check-icon');
            icon?.classList.add('hidden');
          });
          const selectedIcon = option.querySelector('.check-icon');
          selectedIcon?.classList.remove('hidden');
          
          // Close dropdown
          sortDropdown?.classList.add('hidden');
          sortBtn?.setAttribute('aria-expanded', 'false');
          
          // Apply sort
          filterAndSortEntries();
        }
      });
    });

    // Set default sort option as selected
    const defaultOption = document.querySelector('[data-sort="name-asc"]');
    defaultOption?.querySelector('.check-icon')?.classList.remove('hidden');

    // Apply initial sort on page load
    filterAndSortEntries();

    // Sort entries based on current sort option
    function sortEntries(rows: NodeListOf<Element>): Element[] {
      const rowsArray = Array.from(rows);
      
      rowsArray.sort((a, b) => {
        const rowA = a as HTMLElement;
        const rowB = b as HTMLElement;
        
        if (currentSort === 'name-asc') {
          const firstNameA = rowA.getAttribute('data-first-name') || '';
          const firstNameB = rowB.getAttribute('data-first-name') || '';
          return firstNameA.localeCompare(firstNameB);
        } else if (currentSort === 'name-desc') {
          const firstNameA = rowA.getAttribute('data-first-name') || '';
          const firstNameB = rowB.getAttribute('data-first-name') || '';
          return firstNameB.localeCompare(firstNameA);
        } else if (currentSort === 'date') {
          const dateA = rowA.getAttribute('data-created-at') || '';
          const dateB = rowB.getAttribute('data-created-at') || '';
          // Sort descending (newest first)
          return new Date(dateB).getTime() - new Date(dateA).getTime();
        }
        return 0;
      });
      
      return rowsArray;
    }

    // Filter and sort entries based on search and sort
    function filterAndSortEntries() {
      const searchTerm = (searchInput as HTMLInputElement).value.toLowerCase();
      const rows = entriesTbody?.querySelectorAll('tr[data-entry-id]') || [];
      let visibleCount = 0;

      // First, filter entries
      const visibleRows: Element[] = [];
      rows.forEach((row) => {
        const cells = row.querySelectorAll('td');
        // Column order: Name (0), Email (1), Phone (2), Shirt Size (3), Sneaker Size (4), Actions (5)
        const name = cells[0]?.textContent?.toLowerCase() || '';
        const email = cells[1]?.textContent?.toLowerCase() || '';
        const phone = cells[2]?.textContent?.toLowerCase() || '';
        const shirtSize = cells[3]?.textContent?.toLowerCase() || '';
        const sneakerSize = cells[4]?.textContent?.toLowerCase() || '';
        
        const matchesSearch = !searchTerm || 
          name.includes(searchTerm) || 
          email.includes(searchTerm) ||
          phone.includes(searchTerm) ||
          shirtSize.includes(searchTerm) ||
          sneakerSize.includes(searchTerm);
        
        if (matchesSearch) {
          (row as HTMLElement).style.display = '';
          visibleRows.push(row);
          visibleCount++;
        } else {
          (row as HTMLElement).style.display = 'none';
        }
      });

      // Then, sort visible rows
      const sortedRows = sortEntries(visibleRows as any);
      
      // Reorder DOM elements
      sortedRows.forEach((row) => {
        entriesTbody?.appendChild(row);
      });

      const entryCount = document.getElementById('entry-count');
      if (entryCount) {
        entryCount.textContent = visibleCount.toString();
      }
    }

    // CSV Export functionality
    const exportCsvBtn = document.getElementById('export-csv-btn');
    exportCsvBtn?.addEventListener('click', () => {
      const rows = entriesTbody?.querySelectorAll('tr[data-entry-id]') || [];
      const csvRows: string[] = ['Name,Email,Phone,Shirt Size,Sneaker Size'];
      
      rows.forEach((row) => {
        // Only export visible rows
        const isVisible = (row as HTMLElement).style.display !== 'none';
        if (!isVisible) return;
        
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
          const name = cells[0]?.textContent?.trim() || '';
          const email = cells[1]?.textContent?.trim() || '';
          const phone = cells[2]?.textContent?.trim() || '';
          const shirtSize = cells[3]?.textContent?.trim() || '';
          const sneakerSize = cells[4]?.textContent?.trim() || '';
          
          // Escape commas and quotes in CSV
          const escapeCsv = (str: string) => `"${str.replace(/"/g, '""')}"`;
          csvRows.push([
            escapeCsv(name),
            escapeCsv(email),
            escapeCsv(phone),
            escapeCsv(shirtSize),
            escapeCsv(sneakerSize)
          ].join(','));
        }
      });
      
      if (csvRows.length === 1) {
        alert('No entries to export.');
        return;
      }
      
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `entries-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Delete entry functionality
    const deleteButtons = document.querySelectorAll('.delete-entry-btn');
    deleteButtons.forEach((button) => {
      button.addEventListener('click', async (e) => {
        e.stopPropagation();
        const target = e.target as HTMLElement;
        const deleteBtn = target.closest('.delete-entry-btn') as HTMLButtonElement;
        const entryId = parseInt(deleteBtn.getAttribute('data-entry-id') || '0', 10);
        const entryName = deleteBtn.getAttribute('data-entry-name') || 'this submission';
        
        if (!confirm(`Are you sure you want to delete "${entryName}"? This action cannot be undone.`)) {
          return;
        }

        const originalHTML = deleteBtn.innerHTML;
        const originalDisabled = deleteBtn.hasAttribute('disabled');
        
        try {
          // Disable button and show loading state
          deleteBtn.setAttribute('disabled', 'true');
          deleteBtn.classList.add('opacity-60', 'cursor-not-allowed');
          deleteBtn.innerHTML = `
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
          `;

          const response = await fetch('/api/admin/delete-submission', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: entryId })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Remove the row from the table
            const row = deleteBtn.closest('tr[data-entry-id]');
            if (row) {
              row.remove();
              // Update entry count
              const entryCount = document.getElementById('entry-count');
              if (entryCount) {
                const currentCount = parseInt(entryCount.textContent || '0', 10);
                entryCount.textContent = Math.max(0, currentCount - 1).toString();
              }
            }
          } else {
            alert(`Failed to delete entry: ${data.error || 'Unknown error'}`);
            // Restore button state
            deleteBtn.innerHTML = originalHTML;
            if (!originalDisabled) {
              deleteBtn.removeAttribute('disabled');
            }
            deleteBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          }
        } catch (error) {
          console.error('Error deleting entry:', error);
          alert('Failed to delete entry. Please try again.');
          // Restore button state
          deleteBtn.innerHTML = originalHTML;
          if (!originalDisabled) {
            deleteBtn.removeAttribute('disabled');
          }
          deleteBtn.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      });
    });

    // Logout functionality
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn?.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST',
        });
        
        if (response.ok || response.redirected) {
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Logout error:', error);
        // Still redirect to login on error
        window.location.href = '/login';
      }
    });
  </script>
</Layout>

<style>
  .fixed-bg-mobile {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
  }
  
  @media (min-width: 768px) {
    .fixed-bg-mobile {
      position: fixed;
    }
  }
</style>

