---
import Layout from '../layouts/Layout.astro';
import { getAllGrandOpeningEntries } from '../lib/submissions';
import { requireAuth } from '../lib/session';

// Check authentication
try {
  requireAuth(Astro.cookies);
} catch {
  return Astro.redirect('/login', 302);
}

// Fetch grand opening entries only
let entries: Array<{
  id: number;
  firstName: string;
  lastName: string;
  email: string;
  additionalGuests: string;
  checkedIn: boolean;
  createdAt: Date;
}> = [];
let loadError: string | null = null;

try {
  entries = await getAllGrandOpeningEntries();
  // Sort entries alphabetically by name (case-insensitive)
  entries.sort((a, b) => {
    const nameA = `${a.firstName || ''} ${a.lastName || ''}`.trim().toLowerCase();
    const nameB = `${b.firstName || ''} ${b.lastName || ''}`.trim().toLowerCase();
    return nameA.localeCompare(nameB);
  });
} catch (error) {
  console.error('Error loading entries:', error);
  loadError = error instanceof Error ? error.message : String(error);
}
---

<Layout title="Admin Dashboard">
  <div class="min-h-screen relative flex flex-col items-center justify-center px-0 overflow-x-hidden">
    <!-- Background layers matching login page -->
    <div aria-hidden="true" class="absolute inset-0 pointer-events-none">
      <!-- Blue base -->
      <div class="fixed bg-[#59c2ff] inset-0"></div>
      
      <!-- Background image layer -->
      <div class="absolute inset-0">
        <img 
          alt="" 
          class="fixed inset-0 w-full h-full object-cover object-top"
          src="/images/home-bg.jpg"
        />
      </div>
      
      <!-- Black overlay (65% opacity) -->
      <div class="fixed inset-0 bg-black opacity-65"></div>
    </div>

    <!-- Main content container -->
    <div class="relative z-10 flex flex-col items-center justify-center w-full px-2 md:px-8 py-2 md:py-4">
      <div class="bg-[rgba(255,255,255,0.2)] border-2 border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center px-2 md:px-4 py-[40px] pb-2 md:py-[48px] rounded-[4px] w-full max-w-[1400px] gap-[24px]">
        <!-- Header -->
        <div class="flex justify-between items-center w-full mb-4 pb-6 border-b border-white/30">
          <div class="flex flex-row gap-4">
            <a href="/" class="h-[60px] overflow-clip relative shrink-0 w-[95px] md:w-[127px] md:h-[80px] md:ml-0 ml-3">
              <svg width="191" height="103" viewBox="0 0 191 103" fill="none" xmlns="http://www.w3.org/2000/svg" class="block max-w-none size-full">
                <path d="M29.9023 103H20.5L20.9316 97.136H12.1104L9.25293 103H0L22.3936 59.261H31.7637L29.9023 103ZM54.7881 82.6839L61.3174 59.2444H70.8193L58.626 103H49.3564L46.1494 81.2386L40.0859 103H30.8164L43.043 59.2444H51.3164L54.7881 82.6839ZM96.7686 68.6302H88.4121L78.8105 102.999H69.5732L79.1416 68.6302H70.3379L72.9619 59.2444H99.4092L96.7686 68.6302ZM111.105 102.999H101.736L102.151 97.136H93.3633L90.4727 102.999H81.1855L103.63 59.261H112.966L111.105 102.999ZM71.7998 0.00125122C100.123 -0.0526971 128.215 5.09272 154.68 15.1829L167.007 25.6487C149.091 20.9301 130.702 18.2329 112.186 17.6087C143.23 28.8513 170.164 49.1657 189.499 75.8977L190.414 77.1761L171.625 102.99C134.09 50.7354 73.6621 19.7825 9.32031 19.8518C6.64574 19.8518 2.65785 20.0179 0 20.0179L20.9814 5.58231C37.6621 1.84537 54.7057 -0.0263918 71.7998 0.00125122ZM16.0312 88.0491H21.4971L23.1582 72.6009L16.0312 88.0491ZM97.25 88.0491H102.716L104.377 72.5999L97.25 88.0491Z" fill="white"/>
              </svg>
            </a>
          </div>
          <div class="flex gap-2">
            <!-- Export CSV Button -->
            <button
              id="export-csv-btn"
              class="md:px-6 px-3 md:py-3 py-2 border border-white rounded-lg text-white bg-[rgba(255,255,255,0.2)] hover:bg-[rgba(255,255,255,0.3)] transition-colors flex items-center gap-2.5 font-sharp-grotesk-semibold-15 uppercase text-sm"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              Export CSV
            </button>
            <button
              id="logout-btn"
              class="md:px-6 px-3 md:py-3 py-2 border border-white rounded-lg text-white bg-[rgba(255,255,255,0.2)] hover:bg-[rgba(255,255,255,0.3)] transition-colors flex items-center gap-2.5 font-sharp-grotesk-semibold-15 uppercase text-sm"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
              Logout
            </button>
          </div>
        </div>

        <div class="w-full">
          <!-- Search and Filter Section -->
          <div class="flex flex-col sm:flex-row gap-2 sm:gap-5 md:mb-8 mb-3 sm:items-center">
            <div class="flex-1 relative w-full">
              <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <svg class="w-5 h-5 text-white/70" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
              <input
                type="text"
                id="search-input"
                placeholder="SEARCH ENTRIES"
                class="w-full pl-12 pr-5 py-3.5 border border-white rounded-lg bg-[rgba(255,255,255,0.5)] text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-white font-sharp-grotesk-semibold-15 uppercase text-sm"
              />
            </div>
            <div class="relative w-full sm:w-auto">
              <button
                id="sort-btn"
                class="w-full sm:w-auto md:px-6 px-3 md:py-3.5 py-3.5 border border-white rounded-lg text-white bg-[rgba(255,255,255,0.2)] hover:bg-[rgba(255,255,255,0.3)] transition-colors flex items-center gap-2 font-sharp-grotesk-semibold-15 uppercase text-sm sm:min-w-[140px] justify-between"
                aria-expanded="false"
                aria-haspopup="true"
              >
                <span class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                  </svg>
                  <span id="sort-label">Name (A-Z)</span>
                </span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div
                id="sort-dropdown"
                class="hidden absolute right-0 mt-2 w-48 bg-[rgba(255,255,255,0.95)] rounded-lg shadow-lg border border-white/50 z-50"
              >
                <button
                  class="sort-option w-full text-left px-4 py-3 text-sm font-sharp-grotesk-semibold-15 uppercase text-gray-800 hover:bg-gray-100 transition-colors flex items-center justify-between"
                  data-sort="name-asc"
                >
                  <span>Name (A-Z)</span>
                  <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
                <button
                  class="sort-option w-full text-left px-4 py-3 text-sm font-sharp-grotesk-semibold-15 uppercase text-gray-800 hover:bg-gray-100 transition-colors flex items-center justify-between border-t border-gray-200"
                  data-sort="name-desc"
                >
                  <span>Name (Z-A)</span>
                  <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
                <button
                  class="sort-option w-full text-left px-4 py-3 text-sm font-sharp-grotesk-semibold-15 uppercase text-gray-800 hover:bg-gray-100 transition-colors flex items-center justify-between border-t border-gray-200"
                  data-sort="date"
                >
                  <span>Date</span>
                  <svg class="w-4 h-4 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </button>
              </div>
            </div>
            <p class="text-sm font-sharp-grotesk-semibold-15 text-white/90 uppercase tracking-wide text-center sm:text-left md:pr-0 pr-3">
              Showing <span id="entry-count" class="font-sharp-grotesk-bold-15 text-white">{entries.length}</span> Entries
            </p>
          </div>

          <!-- Table Section -->
          <div class="md:mb-8 mb-2">
            <h2 class="text-2xl font-sharp-grotesk-bold-25 text-white uppercase tracking-tight md:mb-4 mb-2 md:pl-0 pl-3 text-center md:text-left">Entries</h2>
          </div>

          <div class="overflow-x-auto rounded-xl shadow-md border border-white/50 bg-[rgba(255,255,255,0.1)] backdrop-blur-sm">
            {entries.length === 0 ? (
              <div class="text-center py-16 text-white/80">
                {loadError ? (
                  <>
                    <p class="text-lg font-sharp-grotesk-semibold-20 mb-2">Could not load entries.</p>
                    <p class="text-sm font-sharp-grotesk-book-20 mb-4">Run <code class="bg-white/20 px-2 py-1 rounded">npm run db:migrate</code> to add the check-in column, then refresh.</p>
                    <p class="text-xs font-sharp-grotesk-book-20 text-white/70 max-w-md mx-auto">{loadError}</p>
                  </>
                ) : (
                  <>
                    <p class="text-lg font-sharp-grotesk-semibold-20 mb-2">No entries found.</p>
                    <p class="text-sm font-sharp-grotesk-book-20">Entries will appear here once users submit the grand opening form.</p>
                  </>
                )}
              </div>
            ) : (
              <table class="w-full border-collapse" style="font-family: Helvetica, Arial, sans-serif;">
                <thead>
                  <tr class="bg-[rgba(255,255,255,0.2)]">
                    <th class="px-2 py-2 md:px-6 md:py-4 text-center text-sm font-sharp-grotesk-bold-15 text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-white/30" style="font-family: Helvetica, Arial, sans-serif;">Check-in</th>
                    <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-sharp-grotesk-bold-15 text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-white/30 border-l border-white/20" style="font-family: Helvetica, Arial, sans-serif;">Name</th>
                    <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-sharp-grotesk-bold-15 text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-white/30 border-l border-white/20" style="font-family: Helvetica, Arial, sans-serif;">Email</th>
                    <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-sharp-grotesk-bold-15 text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-white/30 border-l border-white/20" style="font-family: Helvetica, Arial, sans-serif;">Additional Guests</th>
                    <th class="px-2 py-2 md:px-6 md:py-4 text-left text-sm font-sharp-grotesk-bold-15 text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-white/30 border-l border-white/20" style="font-family: Helvetica, Arial, sans-serif;">Date</th>
                    <th class="px-2 py-2 md:px-6 md:py-4 text-center text-sm font-sharp-grotesk-bold-15 text-white uppercase tracking-wide no-wrap whitespace-nowrap border-b-2 border-white/30 border-l border-white/20" style="font-family: Helvetica, Arial, sans-serif;">Actions</th>
                  </tr>
                </thead>
                <tbody id="entries-tbody" class="divide-y divide-white/20">
                  {entries.map((entry) => {
                  const fullName = `${entry.lastName || ''}, ${entry.firstName || ''}`.trim() || '—';
                  // Sort by last name first, then first name
                  const sortName = `${(entry.lastName || '').toLowerCase()}, ${(entry.firstName || '').toLowerCase()}`.trim();
                  const dateValue = entry.createdAt instanceof Date 
                    ? entry.createdAt.toISOString() 
                    : new Date(entry.createdAt).toISOString();
                  const dateDisplay = entry.createdAt instanceof Date 
                    ? entry.createdAt.toLocaleDateString() 
                    : new Date(entry.createdAt).toLocaleDateString();
                  
                  return (
                    <tr 
                      class="hover:bg-[rgba(255,255,255,0.1)] transition-colors" 
                      data-entry-id={entry.id}
                      data-sort-name={sortName}
                      data-created-at={dateValue}
                      style="font-family: Helvetica, Arial, sans-serif;"
                    >
                      <td class="px-2 py-2 md:px-6 md:py-4 text-center border-l border-white/10" style="font-family: Helvetica, Arial, sans-serif;">
                        <button
                          type="button"
                          class="check-in-btn p-2 rounded-full border-2 border-white/70 bg-transparent hover:bg-white/10 transition-colors inline-flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-white/50"
                          data-entry-id={entry.id}
                          data-checked-in={entry.checkedIn ? 'true' : 'false'}
                          aria-label={entry.checkedIn ? 'Checked in' : 'Not checked in'}
                          title={entry.checkedIn ? 'Checked in — click to undo' : 'Click to check in'}
                        >
                          {entry.checkedIn ? (
                            <svg class="w-[18px] h-[18px] text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                            </svg>
                          ) : (
                            <span class="w-[18px] h-[18px] rounded-full border-2 border-white/70 block" aria-hidden="true"></span>
                          )}
                        </button>
                      </td>
                      <td class="px-2 py-2 md:px-6 md:py-4 text-md font-sharp-grotesk-semibold-20 text-white capitalize border-l border-white/10 whitespace-nowrap" style="font-family: Helvetica, Arial, sans-serif;">{fullName}</td>
                      <td class="px-2 py-2 md:px-6 md:py-4 text-md font-sharp-grotesk-semibold-20 text-white border-l border-white/10" style="font-family: Helvetica, Arial, sans-serif;">{entry.email || '—'}</td>
                      <td class="px-2 py-2 md:px-6 md:py-4 text-md font-sharp-grotesk-semibold-20 text-white border-l border-white/10" style="font-family: Helvetica, Arial, sans-serif;">{entry.additionalGuests ?? '—'}</td>
                      <td class="px-2 py-2 md:px-6 md:py-4 text-md font-sharp-grotesk-semibold-20 text-white border-l border-white/10" style="font-family: Helvetica, Arial, sans-serif;">{dateDisplay}</td>
                      <td class="px-2 py-2 md:px-6 md:py-4 text-center border-l border-white/10" style="font-family: Helvetica, Arial, sans-serif;">
                        <button
                          class="delete-entry-btn px-3 py-1.5 bg-[#d7000f] text-white rounded-lg hover:bg-[#b8323d] transition-colors text-sm font-sharp-grotesk-semibold-15 uppercase flex items-center gap-2 mx-auto"
                          data-entry-id={entry.id}
                          data-entry-name={fullName}
                          style="font-family: Helvetica, Arial, sans-serif;"
                        >
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </td>
                    </tr>
                  );
                  })}
                </tbody>
              </table>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Store original entries data
    const originalEntries = { entries: [...document.querySelectorAll('[data-entry-id]')] };

    // Search functionality
    const searchInput = document.getElementById('search-input');
    const entriesTbody = document.getElementById('entries-tbody');
    let currentSort = 'name-asc'; // Default sort
    
    searchInput?.addEventListener('input', (e) => {
      const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
      filterAndSortEntries();
    });

    // Sort dropdown functionality
    const sortBtn = document.getElementById('sort-btn');
    const sortDropdown = document.getElementById('sort-dropdown');
    const sortLabel = document.getElementById('sort-label');
    const sortOptions = document.querySelectorAll('.sort-option');

    // Toggle dropdown
    sortBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = sortDropdown?.classList.contains('hidden');
      if (isOpen) {
        sortDropdown?.classList.remove('hidden');
        sortBtn.setAttribute('aria-expanded', 'true');
      } else {
        sortDropdown?.classList.add('hidden');
        sortBtn.setAttribute('aria-expanded', 'false');
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!sortBtn?.contains(e.target as Node) && !sortDropdown?.contains(e.target as Node)) {
        sortDropdown?.classList.add('hidden');
        sortBtn?.setAttribute('aria-expanded', 'false');
      }
    });

    // Handle sort option clicks
    sortOptions.forEach((option) => {
      option.addEventListener('click', () => {
        const sortValue = option.getAttribute('data-sort');
        if (sortValue) {
          currentSort = sortValue;
          
          // Update label
          const labels: Record<string, string> = {
            'name-asc': 'Name (A-Z)',
            'name-desc': 'Name (Z-A)',
            'date': 'Date'
          };
          if (sortLabel) {
            sortLabel.textContent = labels[sortValue] || 'Name (A-Z)';
          }
          
          // Update checkmarks
          sortOptions.forEach((opt) => {
            const icon = opt.querySelector('.check-icon');
            icon?.classList.add('hidden');
          });
          const selectedIcon = option.querySelector('.check-icon');
          selectedIcon?.classList.remove('hidden');
          
          // Close dropdown
          sortDropdown?.classList.add('hidden');
          sortBtn?.setAttribute('aria-expanded', 'false');
          
          // Apply sort
          filterAndSortEntries();
        }
      });
    });

    // Set default sort option as selected
    const defaultOption = document.querySelector('[data-sort="name-asc"]');
    defaultOption?.querySelector('.check-icon')?.classList.remove('hidden');

    // Apply initial sort on page load
    filterAndSortEntries();

    // Sort entries based on current sort option
    function sortEntries(rows: NodeListOf<Element>): Element[] {
      const rowsArray = Array.from(rows);
      
      rowsArray.sort((a, b) => {
        const rowA = a as HTMLElement;
        const rowB = b as HTMLElement;
        
        if (currentSort === 'name-asc') {
          const nameA = rowA.getAttribute('data-sort-name') || '';
          const nameB = rowB.getAttribute('data-sort-name') || '';
          return nameA.localeCompare(nameB);
        } else if (currentSort === 'name-desc') {
          const nameA = rowA.getAttribute('data-sort-name') || '';
          const nameB = rowB.getAttribute('data-sort-name') || '';
          return nameB.localeCompare(nameA);
        } else if (currentSort === 'date') {
          const dateA = rowA.getAttribute('data-created-at') || '';
          const dateB = rowB.getAttribute('data-created-at') || '';
          // Sort descending (newest first)
          return new Date(dateB).getTime() - new Date(dateA).getTime();
        }
        return 0;
      });
      
      return rowsArray;
    }

    // Filter and sort entries based on search and sort
    function filterAndSortEntries() {
      const searchTerm = (searchInput as HTMLInputElement).value.toLowerCase();
      const rows = entriesTbody?.querySelectorAll('tr[data-entry-id]') || [];
      let visibleCount = 0;

      // First, filter entries
      const visibleRows: Element[] = [];
      rows.forEach((row) => {
        const cells = row.querySelectorAll('td');
        // Column order: Check-in (0), Name (1), Email (2), Additional Guests (3), Date (4), Actions (5)
        const name = cells[1]?.textContent?.toLowerCase() || '';
        const email = cells[2]?.textContent?.toLowerCase() || '';
        const additionalGuests = cells[3]?.textContent?.toLowerCase() || '';
        const date = cells[4]?.textContent?.toLowerCase() || '';
        
        const matchesSearch = !searchTerm || 
          name.includes(searchTerm) || 
          email.includes(searchTerm) ||
          additionalGuests.includes(searchTerm) ||
          date.includes(searchTerm);
        
        if (matchesSearch) {
          (row as HTMLElement).style.display = '';
          visibleRows.push(row);
          visibleCount++;
        } else {
          (row as HTMLElement).style.display = 'none';
        }
      });

      // Then, sort visible rows
      const sortedRows = sortEntries(visibleRows as any);
      
      // Reorder DOM elements
      sortedRows.forEach((row) => {
        entriesTbody?.appendChild(row);
      });

      const entryCount = document.getElementById('entry-count');
      if (entryCount) {
        entryCount.textContent = visibleCount.toString();
      }
    }

    // CSV Export functionality
    const exportCsvBtn = document.getElementById('export-csv-btn');
    exportCsvBtn?.addEventListener('click', () => {
      const rows = entriesTbody?.querySelectorAll('tr[data-entry-id]') || [];
      const csvRows: string[] = ['Name,Email,Additional Guests,Date'];
      
      rows.forEach((row) => {
        // Only export visible rows
        const isVisible = (row as HTMLElement).style.display !== 'none';
        if (!isVisible) return;
        
        const cells = row.querySelectorAll('td');
        if (cells.length >= 5) {
          const name = cells[1]?.textContent?.trim() || '';
          const email = cells[2]?.textContent?.trim() || '';
          const additionalGuests = cells[3]?.textContent?.trim() || '';
          const date = cells[4]?.textContent?.trim() || '';
          
          // Escape commas and quotes in CSV
          const escapeCsv = (str: string) => `"${str.replace(/"/g, '""')}"`;
          csvRows.push([
            escapeCsv(name),
            escapeCsv(email),
            escapeCsv(additionalGuests),
            escapeCsv(date)
          ].join(','));
        }
      });
      
      if (csvRows.length === 1) {
        alert('No entries to export.');
        return;
      }
      
      const csvContent = csvRows.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `entries-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // Check-in toggle functionality
    document.querySelectorAll('.check-in-btn').forEach((btn) => {
      btn.addEventListener('click', async (e) => {
        const button = (e.target as HTMLElement).closest('.check-in-btn') as HTMLButtonElement;
        if (!button || button.hasAttribute('disabled')) return;
        const entryId = parseInt(button.getAttribute('data-entry-id') || '0', 10);
        const currentlyCheckedIn = button.getAttribute('data-checked-in') === 'true';
        const newCheckedIn = !currentlyCheckedIn;

        if (currentlyCheckedIn && !newCheckedIn) {
          if (!confirm('Remove check-in for this guest? They will show as not checked in.')) {
            return;
          }
        }

        button.setAttribute('disabled', 'true');
        const originalHTML = button.innerHTML;

        try {
          const response = await fetch('/api/admin/check-in', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: entryId, checkedIn: newCheckedIn }),
          });
          const data = await response.json();

          if (data.success) {
            button.setAttribute('data-checked-in', newCheckedIn ? 'true' : 'false');
            button.setAttribute('aria-label', newCheckedIn ? 'Checked in' : 'Not checked in');
            button.setAttribute('title', newCheckedIn ? 'Checked in — click to undo' : 'Click to check in');
            if (newCheckedIn) {
              button.innerHTML = `
                <svg class="w-[18px] h-[18px] text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
                </svg>
              `;
            } else {
              button.innerHTML = `<span class="w-[18px] h-[18px] rounded-full border-2 border-white/70 block" aria-hidden="true"></span>`;
            }
          }
        } catch (err) {
          console.error('Check-in error:', err);
        }
        button.removeAttribute('disabled');
      });
    });

    // Delete entry functionality
    const deleteButtons = document.querySelectorAll('.delete-entry-btn');
    deleteButtons.forEach((button) => {
      button.addEventListener('click', async (e) => {
        e.stopPropagation();
        const target = e.target as HTMLElement;
        const deleteBtn = target.closest('.delete-entry-btn') as HTMLButtonElement;
        const entryId = parseInt(deleteBtn.getAttribute('data-entry-id') || '0', 10);
        const entryName = deleteBtn.getAttribute('data-entry-name') || 'this submission';
        
        if (!confirm(`Are you sure you want to delete "${entryName}"? This action cannot be undone.`)) {
          return;
        }

        const originalHTML = deleteBtn.innerHTML;
        const originalDisabled = deleteBtn.hasAttribute('disabled');
        
        try {
          // Disable button and show loading state
          deleteBtn.setAttribute('disabled', 'true');
          deleteBtn.classList.add('opacity-60', 'cursor-not-allowed');
          deleteBtn.innerHTML = `
            <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
          `;

          const response = await fetch('/api/admin/delete-submission', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: entryId })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Remove the row from the table
            const row = deleteBtn.closest('tr[data-entry-id]');
            if (row) {
              row.remove();
              // Update entry count
              const entryCount = document.getElementById('entry-count');
              if (entryCount) {
                const currentCount = parseInt(entryCount.textContent || '0', 10);
                entryCount.textContent = Math.max(0, currentCount - 1).toString();
              }
            }
          } else {
            alert(`Failed to delete entry: ${data.error || 'Unknown error'}`);
            // Restore button state
            deleteBtn.innerHTML = originalHTML;
            if (!originalDisabled) {
              deleteBtn.removeAttribute('disabled');
            }
            deleteBtn.classList.remove('opacity-60', 'cursor-not-allowed');
          }
        } catch (error) {
          console.error('Error deleting entry:', error);
          alert('Failed to delete entry. Please try again.');
          // Restore button state
          deleteBtn.innerHTML = originalHTML;
          if (!originalDisabled) {
            deleteBtn.removeAttribute('disabled');
          }
          deleteBtn.classList.remove('opacity-60', 'cursor-not-allowed');
        }
      });
    });

    // Logout functionality
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn?.addEventListener('click', async () => {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST',
        });
        
        if (response.ok || response.redirected) {
          window.location.href = '/login';
        }
      } catch (error) {
        console.error('Logout error:', error);
        // Still redirect to login on error
        window.location.href = '/login';
      }
    });
  </script>
</Layout>

