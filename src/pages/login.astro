---
import Layout from '../layouts/Layout.astro';

let error = '';
let success = '';
let debugInfo = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const username = formData.get('username')?.toString() || '';
  const password = formData.get('password')?.toString() || '';
  
  console.log('=== LOGIN ATTEMPT ===');
  console.log('Username/Email:', username);
  console.log('Password length:', password.length);
  
  if (username && password) {
    try {
      console.log('Importing auth module...');
      const { getAdminByUsername, getAdminByEmail, verifyPassword } = await import('../lib/auth');
      const { createSession } = await import('../lib/session');
      
      console.log('Auth module imported successfully');
      console.log('Checking for admin with:', username);
      
      // Try username first, then email
      let admin = await getAdminByUsername(username);
      console.log('Username lookup result:', admin ? 'Found' : 'Not found');
      
      if (!admin) {
        admin = await getAdminByEmail(username);
        console.log('Email lookup result:', admin ? 'Found' : 'Not found');
      }
      
      if (!admin) {
        console.log('❌ Admin not found');
        error = 'Invalid username or password';
        debugInfo = `No admin found with username or email: ${username}`;
      } else {
        console.log('✅ Admin found:', admin.username, admin.email);
        console.log('Verifying password...');
        
        const isValid = await verifyPassword(password, admin.passwordHash);
        console.log('Password verification result:', isValid);
        
        if (isValid) {
          console.log('Creating session...');
          const sessionId = createSession(Astro.cookies, admin.id);
          console.log('✅ Session created:', sessionId);
          console.log('Redirecting to /admin...');
          return Astro.redirect('/admin');
        } else {
          console.log('❌ Password verification failed');
          error = 'Invalid username or password';
          debugInfo = 'Password does not match';
        }
      }
    } catch (err) {
      console.error('❌ LOGIN ERROR:', err);
      if (err instanceof Error) {
        console.error('Error message:', err.message);
        console.error('Error stack:', err.stack);
        error = `Login error: ${err.message}`;
        debugInfo = err.stack || '';
      } else {
        error = 'An error occurred during login. Please try again.';
        debugInfo = String(err);
      }
    }
  } else {
    error = 'Please fill in all fields';
    debugInfo = `Username: ${username ? 'provided' : 'missing'}, Password: ${password ? 'provided' : 'missing'}`;
  }
  
  console.log('=== LOGIN ATTEMPT END ===');
}

const resetMessage = Astro.url.searchParams.get('reset');
if (resetMessage === 'success') {
  success = 'Password reset successful! You can now login.';
}
---

<Layout title="Login">
  <div class="min-h-screen relative flex flex-col items-center justify-center pt-[80px] md:pt-[50px] px-0 overflow-x-hidden">
    <!-- Background layers matching index page -->
    <div aria-hidden="true" class="absolute inset-0 pointer-events-none">
      <!-- Blue base -->
      <div class="fixed bg-[#59c2ff] inset-0"></div>
      
      <!-- Background image layer -->
      <div class="absolute inset-0">
        <img 
          alt="" 
          class="fixed inset-0 w-full h-full object-cover object-top"
          src="/images/home-bg.jpg"
        />
      </div>
      
      <!-- Black overlay (65% opacity) -->
      <div class="fixed inset-0 bg-black opacity-65"></div>
    </div>

    <!-- Main content container -->
    <div class="relative z-10 flex flex-col items-center justify-center w-full px-[20px] py-[40px]">
      <div class="bg-[rgba(255,255,255,0.2)] border-2 border-[rgba(255,255,255,0.5)] border-solid flex flex-col items-center justify-center px-[32px] md:px-[48px] py-[40px] md:py-[48px] rounded-[4px] w-full max-w-[500px] gap-[24px]">
        <h1 class="font-sharp-grotesk-semibold-25 text-white text-[32px] md:text-[40px] text-center uppercase mb-0">Admin Login</h1>
        
        {error && (
          <div class="error-message w-full">
            {error}
            {debugInfo && import.meta.env.MODE === 'development' && (
              <div class="mt-2 text-sm opacity-80">
                Debug: {debugInfo}
              </div>
            )}
          </div>
        )}
        {success && <div class="success-message w-full">{success}</div>}
        
        <form method="POST" class="login-form w-full flex flex-col gap-[24px]">
          <div class="form-group flex flex-col gap-[12px]">
            <label for="username" class="font-sharp-grotesk-medium-20 text-white text-[16px]">Username</label>
            <input 
              type="text" 
              id="username" 
              name="username" 
              required 
              autocomplete="username"
              class="bg-[rgba(255,255,255,0.5)] border border-solid border-white h-[48px] px-[16px] py-[12px] rounded-[4px] font-sharp-grotesk-book-20 text-[#212121] text-[14px] md:text-[16px] placeholder:text-[#212121] focus:outline-none focus:border-white transition-colors"
            />
          </div>
          
          <div class="form-group flex flex-col gap-[12px]">
            <label for="password" class="font-sharp-grotesk-medium-20 text-white text-[16px]">Password</label>
            <input 
              type="password" 
              id="password" 
              name="password" 
              required 
              autocomplete="current-password"
              class="bg-[rgba(255,255,255,0.5)] border border-solid border-white h-[48px] px-[16px] py-[12px] rounded-[4px] font-sharp-grotesk-book-20 text-[#212121] text-[14px] md:text-[16px] placeholder:text-[#212121] focus:outline-none focus:border-white transition-colors"
            />
          </div>
          
          <button type="submit" class="bg-[#d7000f] border border-solid border-white cursor-pointer px-[24px] py-[16px] md:py-[20px] rounded-[4px] w-full font-sharp-grotesk-semibold-15 text-[20px] md:text-[24px] text-center text-white tracking-[2px] md:tracking-[3px] uppercase hover:bg-[#b8323d] transition-colors mt-[8px]">Login</button>
        </form>
        
        <div class="reset-link w-full text-center mt-[8px]">
          <a href="/reset-password" class="font-sharp-grotesk-book-20 text-white text-[14px] md:text-[16px] underline hover:no-underline">Forgot your password?</a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .error-message {
    background: rgba(255, 0, 0, 0.2);
    color: #ffcccc;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 0;
    border: 1px solid rgba(255, 200, 200, 0.5);
    font-size: 14px;
    font-family: var(--font-sharp-grotesk-book-20);
  }
  
  .success-message {
    background: rgba(0, 255, 0, 0.2);
    color: #ccffcc;
    padding: 0.75rem 1rem;
    border-radius: 4px;
    margin-bottom: 0;
    border: 1px solid rgba(200, 255, 200, 0.5);
    font-size: 14px;
    font-family: var(--font-sharp-grotesk-book-20);
  }
</style>

