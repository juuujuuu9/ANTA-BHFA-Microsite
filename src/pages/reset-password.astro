---
import Layout from '../layouts/Layout.astro';
import { getAdminByEmail, setResetToken } from '../lib/auth';
import { sendPasswordResetEmail } from '../lib/email';
import { nanoid } from 'nanoid';

let error = '';
let success = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const email = formData.get('email')?.toString() || '';
  
  if (email) {
    const admin = await getAdminByEmail(email);
    
    if (admin) {
      const resetToken = nanoid();
      const expiry = new Date();
      expiry.setHours(expiry.getHours() + 1); // 1 hour expiry
      
      await setResetToken(admin.id, resetToken, expiry);
      
      const appUrl = process.env.APP_URL || 'http://localhost:4321';
      const resetLink = `${appUrl}/reset-password/${resetToken}`;
      
      await sendPasswordResetEmail(admin.email, resetLink);
      success = 'If an account with that email exists, a password reset link has been sent.';
    } else {
      // Don't reveal if email exists or not for security
      success = 'If an account with that email exists, a password reset link has been sent.';
    }
  } else {
    error = 'Please enter your email address';
  }
}
---

<Layout title="Reset Password">
  <div class="reset-container">
    <div class="reset-card">
      <h1>Reset Password</h1>
      
      {error && <div class="error-message">{error}</div>}
      {success && <div class="success-message">{success}</div>}
      
      {!success && (
        <form method="POST" class="reset-form">
          <div class="form-group">
            <label for="email">Email Address</label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              required 
              autocomplete="email"
              placeholder="Enter your email address"
            />
          </div>
          
          <button type="submit" class="btn-primary">Send Reset Link</button>
        </form>
      )}
      
      <div class="back-link">
        <a href="/login">Back to Login</a>
      </div>
    </div>
  </div>
</Layout>

<style>
  .reset-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
  }
  
  .reset-card {
    background: white;
    border-radius: 12px;
    padding: 2.5rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 400px;
  }
  
  .reset-card h1 {
    margin: 0 0 2rem 0;
    color: #333;
    text-align: center;
  }
  
  .reset-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .form-group label {
    font-weight: 600;
    color: #555;
    font-size: 0.9rem;
  }
  
  .form-group input {
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  
  .form-group input:focus {
    outline: none;
    border-color: #667eea;
  }
  
  .btn-primary {
    padding: 0.75rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  .back-link {
    margin-top: 1.5rem;
    text-align: center;
  }
  
  .back-link a {
    color: #667eea;
    text-decoration: none;
    font-size: 0.9rem;
  }
  
  .back-link a:hover {
    text-decoration: underline;
  }
  
  .error-message {
    background: #fee;
    color: #c33;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    border: 1px solid #fcc;
  }
  
  .success-message {
    background: #efe;
    color: #3c3;
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 1rem;
    border: 1px solid #cfc;
  }
</style>

